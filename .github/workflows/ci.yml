name: CI

on:
  push:
    branches:
      - master
      - release
      - feat/**
  pull_request:

jobs:
  secret-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7
        with:
          config-path: .gitleaks.toml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  backend-build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9
        with:
          dotnet-version: |
            8.0.x

      - name: Restore
        run: dotnet restore src/Barcode.Generator.sln

      - name: Build
        run: dotnet build src/Barcode.Generator.sln --configuration Release --no-restore

      - name: Test
        run: dotnet test src/Barcode.Generator.sln --configuration Release --no-build

  frontend-build:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: src/Demo.Web

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: src/Demo.Web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Security audit (high+)
        run: npm audit --audit-level=high

      - name: Build frontend
        run: npm run build

  frontend-e2e:
    runs-on: ubuntu-latest
    needs: frontend-build

    defaults:
      run:
        working-directory: src/Demo.Web

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: src/Demo.Web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload Playwright report (on failure)
        if: failure()
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: playwright-report
          path: src/Demo.Web/playwright-report
          if-no-files-found: ignore
